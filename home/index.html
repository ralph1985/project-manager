<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Project Manager · Ayuntamiento de Belmontejo</title>
  <link rel="stylesheet" href="./styles.css">
</head>
<body>
  <header>
    <div class="title">
      <h1>Panel de proyectos municipales</h1>
      <p>Seguimiento de tareas y horas en todos los proyectos</p>
    </div>
    <div class="pill">Project Manager · Home</div>
  </header>

  <main class="layout">
    <section class="grid" id="stats"></section>

    <div class="grid">
      <div class="card">
        <h2>Fases y horas por proyecto</h2>
        <div id="project-phases" class="project-phases"></div>
      </div>
    </div>

    <div class="card table-card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
        <h2 style="margin:0;">Tareas</h2>
      </div>
      <div class="filters">
        <div class="filter-group">
          <label for="search">Buscar</label>
          <input type="search" id="search" placeholder="Buscar título o notas">
        </div>
        <div class="filter-group">
          <label for="projectFilter">Proyecto</label>
          <select id="projectFilter" multiple size="4" aria-label="Filtrar por proyecto"></select>
        </div>
        <div class="filter-group">
          <label for="phaseFilter">Fase</label>
          <select id="phaseFilter" multiple size="4" aria-label="Filtrar por fase"></select>
        </div>
        <div class="filter-group">
          <label for="ownerFilter">Responsable</label>
          <select id="ownerFilter" multiple size="4" aria-label="Filtrar por responsable"></select>
        </div>
        <div class="filter-group">
          <label for="statusFilter">Estado</label>
          <select id="statusFilter" multiple size="4" aria-label="Filtrar por estado"></select>
        </div>
      </div>
      <div class="table-container">
        <table class="table" id="tasksTable">
          <colgroup>
            <col style="width:3%">
            <col style="width:26%">
            <col style="width:12%">
            <col style="width:9%">
            <col style="width:10%">
            <col style="width:10%">
            <col style="width:7%">
            <col style="width:7%">
            <col style="width:10%">
            <col style="width:6%">
          </colgroup>
          <thead>
            <tr>
              <th class="sortable" data-sort="id"><span>#</span><span class="sort-indicator"></span></th>
              <th class="sortable" data-sort="title"><span>Tarea</span><span class="sort-indicator"></span></th>
              <th class="sortable" data-sort="project"><span>Proyecto</span><span class="sort-indicator"></span></th>
              <th class="sortable" data-sort="phase"><span>Fase</span><span class="sort-indicator"></span></th>
              <th class="sortable" data-sort="owner"><span>Responsable</span><span class="sort-indicator"></span></th>
              <th class="sortable" data-sort="status"><span>Estado</span><span class="sort-indicator"></span></th>
              <th class="sortable" data-sort="startDate"><span>Inicio</span><span class="sort-indicator"></span></th>
              <th class="sortable" data-sort="endDate"><span>Fin</span><span class="sort-indicator"></span></th>
              <th><span>Notas</span></th>
              <th class="num sortable" data-sort="hours"><span>Horas</span><span class="sort-indicator"></span></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div id="noteModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="noteModalTitle">
      <div class="modal-backdrop"></div>
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="noteModalTitle">Nota</h3>
          <button id="noteClose" class="close-btn" aria-label="Cerrar">×</button>
        </div>
        <div id="noteBody" class="modal-body"></div>
      </div>
    </div>
  </main>

  <script>
    const FILTER_KEY = 'pm-filters';
    const HOURLY_RATE = 50; // €/hora bruta
    let currentSort = { key: 'id', dir: 'desc' };
    const fmt = (n) => Number.isFinite(n) ? n.toLocaleString('es-ES', { minimumFractionDigits: 0, maximumFractionDigits: 1 }) : '—';
    const fmtCurrency = (n) => Number.isFinite(n) ? n.toLocaleString('es-ES', { style: 'currency', currency: 'EUR', minimumFractionDigits: 0, maximumFractionDigits: 0 }) : '—';
    const escAttr = (str = '') => str.replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/</g, '&lt;');
    const statusClass = (status) => {
      if (!status) return 'status-No';
      if (status.startsWith('Comp')) return 'status-Completa';
      if (status.startsWith('En')) return 'status-En';
      if (status.startsWith('B')) return 'status-Bloqueada';
      if (status.startsWith('No')) return 'status-No';
      if (status.startsWith('Canc')) return 'status-Cancelada';
      return 'status-No';
    };
    const phaseClass = (phase) => {
      if (!phase) return 'phase-Default';
      if (phase.startsWith('Pre')) return 'phase-Pre';
      if (phase.startsWith('Mant')) return 'phase-Mant';
      return 'phase-Default';
    };
    const projectClass = (project) => {
      if (!project) return 'project-Default';
      if (project.includes('Belmontejo')) return 'project-Belmontejo';
      if (project.includes('Palomares')) return 'project-Palomares';
      if (project.includes('Gestor')) return 'project-Gestor';
      return 'project-Default';
    };
    const parseDate = (str) => {
      if (!str) return 0;
      const parts = str.split('/').map(Number);
      if (parts.length !== 3 || Number.isNaN(parts[2])) return 0;
      return new Date(parts[2], parts[1] - 1, parts[0]).getTime();
    };
    const sorters = {
      id: (t) => t.id,
      title: (t) => (t.title || '').toLowerCase(),
      project: (t) => (t.project || '').toLowerCase(),
      phase: (t) => (t.phase || '').toLowerCase(),
      owner: (t) => (t.owner || '').toLowerCase(),
      status: (t) => (t.status || '').toLowerCase(),
      startDate: (t) => parseDate(t.startDate),
      endDate: (t) => parseDate(t.endDate),
      hours: (t) => t.hours || 0
    };
    function sortTasks(tasks) {
      const fn = sorters[currentSort.key] || sorters.id;
      const dir = currentSort.dir === 'asc' ? 1 : -1;
      return [...tasks].sort((a, b) => {
        const va = fn(a);
        const vb = fn(b);
        if (va === vb) return 0;
        return va > vb ? dir : -dir;
      });
    }

    const renderNoteCell = (note) => {
      if (!note) return '—';
      const shortText = note.length > 40 ? `${note.slice(0, 40)}…` : note;
      return `<button class="note-link" data-note="${escAttr(note)}" title="Ver nota completa">${shortText}</button>`;
    };

    async function loadTasks() {
      const res = await fetch('../data/projects-tasks.json');
      const tasks = await res.json();
      return tasks.map(t => ({
        ...t,
        project: t.project || (['Fase 1', 'Mantenimiento', 'Errores'].includes(t.phase) ? 'Ayuntamiento de Belmontejo' : t.project || null),
      }));
    }

    function aggregate(tasks, key) {
      return tasks.reduce((acc, t) => {
        const k = t[key] || '—';
        const current = acc[k] || { hours: 0, count: 0 };
        acc[k] = { hours: current.hours + (t.hours || 0), count: current.count + 1 };
        return acc;
      }, {});
    }

    function renderStats(tasks) {
      const statsEl = document.getElementById('stats');
      const totalHours = tasks.reduce((sum, t) => sum + (t.hours || 0), 0);
      const totalCost = totalHours * HOURLY_RATE;
      const statusCounts = tasks.reduce((acc, t) => {
        acc[t.status] = (acc[t.status] || 0) + 1;
        return acc;
      }, {});
      const cards = [
        { label: 'Tareas totales', value: tasks.length },
        { label: 'Tareas completadas', value: statusCounts['Completada'] || 0 },
        { label: 'Tareas en curso', value: statusCounts['En curso'] || 0 },
        { label: 'Tareas Bloqueadas', value: statusCounts['Bloqueada'] || 0 },
        { label: 'Horas registradas', value: fmt(totalHours) },
        { label: 'Coste bruto (50€/h)', value: fmtCurrency(totalCost) },
      ];
      statsEl.innerHTML = cards.map(card => `
        <div class="card">
          <div class="stat-label">${card.label}</div>
          <div class="stat-value">${card.value}</div>
        </div>
      `).join('');
    }

    function renderBars(targetId, dataMap) {
      const container = document.getElementById(targetId);
      const entries = Object.entries(dataMap).sort((a, b) => b[1].hours - a[1].hours);
      const max = entries[0]?.[1].hours || 1;
      container.innerHTML = entries.map(([label, v]) => `
        <div class="bar-row">
          <div style="width:110px;color:var(--muted);font-size:13px;">${label}</div>
          <div class="bar"><span style="width:${(v.hours / max) * 100}%"></span></div>
          <div style="width:64px;text-align:right;font-weight:600">${fmt(v.hours)}</div>
        </div>
      `).join('');
    }

    function renderProjectPhases(tasks) {
      const container = document.getElementById('project-phases');
      const totals = tasks.reduce((acc, t) => {
        const project = t.project || 'Sin proyecto';
        const phase = t.phase || '—';
        const phaseKey = `${project}::${phase}`;
        acc.projects[project] = (acc.projects[project] || 0) + (t.hours || 0);
        acc.phases[phaseKey] = (acc.phases[phaseKey] || 0) + (t.hours || 0);
        return acc;
      }, { projects: {}, phases: {} });

      const projects = Object.entries(totals.projects).sort((a, b) => b[1] - a[1]);
      const maxProjectHours = projects[0]?.[1] || 1;

      container.innerHTML = projects.map(([project, hours]) => {
        const phases = Object.entries(totals.phases)
          .filter(([k]) => k.startsWith(`${project}::`))
          .map(([k, h]) => ({ phase: k.split('::')[1], hours: h }))
          .sort((a, b) => b.hours - a.hours);
        const maxPhase = phases[0]?.hours || 1;
        return `
          <div class="project-phase-item">
            <div class="project-phase-header">
              <span class="project-name">${project}</span>
              <span class="project-hours">${fmt(hours)} h <small style="color:var(--muted);font-weight:500;">· ${fmtCurrency(hours * HOURLY_RATE)}</small></span>
            </div>
            <div class="bar-row overall">
              <div class="phase-label">Total</div>
              <div class="bar"><span style="width:${(hours / maxProjectHours) * 100}%"></span></div>
              <div class="phase-hours">${fmt(hours)} h <small style="color:var(--muted);font-weight:500;">· ${fmtCurrency(hours * HOURLY_RATE)}</small></div>
            </div>
            ${phases.map(p => `
              <div class="bar-row">
                <div class="phase-label">${p.phase}</div>
                <div class="bar"><span style="width:${(p.hours / maxPhase) * 100}%"></span></div>
                <div class="phase-hours">${fmt(p.hours)} h</div>
              </div>
            `).join('')}
          </div>
        `;
      }).join('');
    }

    function renderFilters(tasks) {
      const statuses = Array.from(new Set(tasks.map(t => t.status))).sort();
      const owners = Array.from(new Set(tasks.map(t => t.owner))).sort();
      const phases = Array.from(new Set(tasks.map(t => t.phase))).sort();
      const projects = Array.from(new Set(tasks.map(t => t.project))).sort();
      const setOptions = (el, values) => {
        el.innerHTML = [`<option value="">Todos</option>`, ...values.map(v => `<option value="${v}">${v}</option>`)].join('');
      };
      setOptions(document.getElementById('statusFilter'), statuses);
      setOptions(document.getElementById('ownerFilter'), owners);
      setOptions(document.getElementById('phaseFilter'), phases);
      setOptions(document.getElementById('projectFilter'), projects);
    }

    function loadFilterState() {
      try {
        return JSON.parse(localStorage.getItem(FILTER_KEY)) || {};
      } catch (_) {
        return {};
      }
    }

    function saveFilterState(state) {
      try {
        localStorage.setItem(FILTER_KEY, JSON.stringify(state));
      } catch (_) {
        // ignore storage errors (private mode, quota, etc.)
      }
    }

    function applySavedFilters(saved) {
      const search = document.getElementById('search');
      const statusSel = document.getElementById('statusFilter');
      const ownerSel = document.getElementById('ownerFilter');
      const phaseSel = document.getElementById('phaseFilter');
      const projectSel = document.getElementById('projectFilter');
      const setSelected = (select, values = []) => {
        Array.from(select.options).forEach(opt => {
          opt.selected = values.includes(opt.value);
        });
      };
      search.value = saved.search || '';
      setSelected(statusSel, saved.status);
      setSelected(ownerSel, saved.owner);
      setSelected(phaseSel, saved.phase);
      setSelected(projectSel, saved.project);
    }

    function renderTable(tasks) {
      const tbody = document.querySelector('#tasksTable tbody');
      tbody.innerHTML = tasks.map(t => `
        <tr>
              <td>${t.id}</td>
              <td>${t.title}</td>
              <td><span class="badge ${projectClass(t.project)} pill-status">${t.project || '—'}</span></td>
              <td><span class="badge ${phaseClass(t.phase)} pill-status">${t.phase || '—'}</span></td>
              <td>${t.owner || '—'}</td>
              <td><span class="badge ${statusClass(t.status)} pill-status">${t.status}</span></td>
              <td>${t.startDate || '—'}</td>
              <td>${t.endDate || '—'}</td>
              <td>${renderNoteCell(t.notes)}</td>
          <td class="num">${fmt(t.hours)}</td>
        </tr>
      `).join('');
    }

    function updateSortIndicators() {
      const headers = document.querySelectorAll('#tasksTable thead th.sortable');
      headers.forEach((th) => {
        const key = th.dataset.sort;
        const indicator = th.querySelector('.sort-indicator');
        th.classList.toggle('active', currentSort.key === key);
        if (indicator) {
          indicator.textContent =
            currentSort.key === key ? (currentSort.dir === 'asc' ? '▲' : '▼') : '';
        }
      });
    }

    function setupFilters(allTasks) {
      const search = document.getElementById('search');
      const statusSel = document.getElementById('statusFilter');
      const ownerSel = document.getElementById('ownerFilter');
      const phaseSel = document.getElementById('phaseFilter');
      const projectSel = document.getElementById('projectFilter');

      const selectedValues = (select) =>
        Array.from(select.selectedOptions).map(o => o.value);
      const normalizeSelected = (values) =>
        values.includes('') ? [] : values.filter(Boolean);

      function apply() {
        const term = search.value.toLowerCase().trim();
        const statusValues = normalizeSelected(selectedValues(statusSel));
        const ownerValues = normalizeSelected(selectedValues(ownerSel));
        const phaseValues = normalizeSelected(selectedValues(phaseSel));
        const projectValues = normalizeSelected(selectedValues(projectSel));
        const filtered = allTasks.filter(t => {
          const matchesTerm = !term || `${t.title} ${t.notes || ''}`.toLowerCase().includes(term);
          const matchesStatus = statusValues.length === 0 || statusValues.includes(t.status);
          const matchesOwner = ownerValues.length === 0 || ownerValues.includes(t.owner);
          const matchesPhase = phaseValues.length === 0 || phaseValues.includes(t.phase);
          const matchesProject = projectValues.length === 0 || projectValues.includes(t.project);
          return matchesTerm && matchesStatus && matchesOwner && matchesPhase && matchesProject;
        });
        renderTable(sortTasks(filtered));
        saveFilterState({
          search: term,
          status: statusValues,
          owner: ownerValues,
          phase: phaseValues,
          project: projectValues,
        });
      }

      [search, statusSel, ownerSel, phaseSel, projectSel].forEach(el => el.addEventListener('input', apply));
      [statusSel, ownerSel, phaseSel, projectSel].forEach(el => el.addEventListener('change', apply));
      apply();
      return apply;
    }

    function setupSorting(applyFilters) {
      const headers = document.querySelectorAll('#tasksTable thead th.sortable');
      headers.forEach((th) => {
        th.addEventListener('click', () => {
          const key = th.dataset.sort;
          if (currentSort.key === key) {
            currentSort = { key, dir: currentSort.dir === 'asc' ? 'desc' : 'asc' };
          } else {
            currentSort = { key, dir: 'asc' };
          }
          updateSortIndicators();
          applyFilters();
        });
      });
      updateSortIndicators();
    }

    (async function init() {
      const tasks = await loadTasks();
      const noteModal = document.getElementById('noteModal');
      const noteBody = document.getElementById('noteBody');
      const noteClose = document.getElementById('noteClose');
      const hideNote = () => noteModal.classList.add('hidden');
      const showNote = (text) => {
        noteBody.textContent = text;
        noteModal.classList.remove('hidden');
      };

      renderStats(tasks);
      renderProjectPhases(tasks);
      renderFilters(tasks);
      applySavedFilters(loadFilterState());
      const applyFilters = setupFilters(tasks);
      setupSorting(applyFilters);

      document.addEventListener('click', (e) => {
        const btn = e.target.closest('.note-link');
        if (btn) {
          e.preventDefault();
          showNote(btn.dataset.note || '');
        }
        if (e.target.classList.contains('modal-backdrop')) {
          hideNote();
        }
      });
      noteClose.addEventListener('click', hideNote);
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') hideNote();
      });
    })();
  </script>
</body>
</html>
